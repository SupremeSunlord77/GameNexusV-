// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------
// 1. USER & IDENTITY
// --------------------------------------

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  passwordHash   String
  username       String   @unique
  role           UserRole @default(USER)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // --- BEHAVIOR & ADMIN SYSTEM ---
  reputation     Int      @default(50)    // The "Meter" (0-100)
  toxicityFlags  Int      @default(0)     // How many times AI caught them
  isBanned       Boolean  @default(false) // Can Admin ban them?

  // ðŸ†• BEHAVIORAL PROFILING - NEW FIELDS
  behavioralVectors Json?     // 5D behavioral profile (communication, competitive, etc.)
  gamerDNA          Json?     // Bartle type, play style tags, assessment date
  eigenTrustScore   Float     @default(0.5) // Trust graph score (0-1)
  endorsements      Json?     // Endorsement counts: {teamPlayer: 5, positive: 12, etc.}

  // --- NEW: RELATION FOR ADMIN ACTIONS ---
  auditLogs      AuditLog[] @relation("AdminActions")

  // 1:1 Relations
  profile           UserProfile?
  reputationScore   ReputationScore?

  // 1:N Relations
  hostedSessions    LFGSession[]     @relation("Host")
  joinedSessions    LFGParticipant[]
   
  // Feedback
  feedbackGiven     Feedback[]       @relation("GivenFeedback")
  feedbackReceived  Feedback[]       @relation("ReceivedFeedback")

  // Chat
  messages          ChatMessage[]
  
  // ðŸ†• TRUST GRAPH RELATIONS - NEW
  givenTrust        TrustEdge[]   @relation("GivenTrust")
  receivedTrust     TrustEdge[]   @relation("ReceivedTrust")
}

model UserProfile {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  displayName       String?
  bio               String?
  region            String
  primaryLanguage   String   @default("English")
  
  playStyle         PlayStyle @default(CASUAL)
  communicationPref CommType  @default(VOICE)
  
  avatarUrl         String?
}

// --------------------------------------
// 2. BEHAVIOR & REPUTATION ENGINE
// --------------------------------------

model ReputationScore {
  id                 String   @id @default(uuid())
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  positivityScore    Float    @default(50.0)
  reliabilityScore   Float    @default(50.0)
  communicationScore Float    @default(50.0)
  
  totalFeedbacks     Int      @default(0)
  lastUpdated        DateTime @default(now())
}

model Feedback {
  id           String   @id @default(uuid())
  
  fromUserId   String
  toUserId     String
  sessionId    String

  positivity   Int
  reliability  Int
  communication Int
  comment      String?
  
  createdAt    DateTime @default(now())

  fromUser User       @relation("GivenFeedback", fields: [fromUserId], references: [id])
  toUser   User       @relation("ReceivedFeedback", fields: [toUserId], references: [id])
  session  LFGSession @relation(fields: [sessionId], references: [id])

  @@unique([fromUserId, toUserId, sessionId])
}

// --------------------------------------
// 3. MATCHMAKING & SESSIONS (LFG)
// --------------------------------------

model Game {
  id        String   @id @default(uuid())
  name      String   @unique
  genre     String?
  sessions  LFGSession[]
}

model LFGSession {
  id             String        @id @default(uuid())
  hostUserId     String
  gameId         String
  
  title          String
  description    String?
  region         String
  micRequired    Boolean       @default(false)
  
  maxPlayers     Int
  currentPlayers Int           @default(1)
  
  status         SessionStatus @default(OPEN)
  startTime      DateTime      @default(now())
  createdAt      DateTime      @default(now())

  // ðŸ†• BEHAVIORAL REQUIREMENTS - NEW (Optional filters)
  minCompatibility Float?   @default(0.4) // Minimum compatibility score to join (0-1)
  minEigenTrust    Float?   @default(0)   // Minimum trust score to join (0-1)

  host           User             @relation("Host", fields: [hostUserId], references: [id])
  game           Game             @relation(fields: [gameId], references: [id])
  participants   LFGParticipant[]
  feedback       Feedback[]
  messages       ChatMessage[]
}

model LFGParticipant {
  id        String   @id @default(uuid())
  sessionId String
  userId    String
  joinedAt  DateTime @default(now())

  session   LFGSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id])

  @@unique([sessionId, userId])
}

// --------------------------------------
// 4. CHAT MESSAGES (With AI Flags)
// --------------------------------------

model ChatMessage {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())

  // --- NEW: AI FLAGS ---
  isToxic   Boolean  @default(false)

  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  sessionId String
  session   LFGSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

// --------------------------------------
// 5. ENUMS
// --------------------------------------

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum SessionStatus {
  OPEN
  FULL
  CLOSED
  COMPLETED
}

enum PlayStyle {
  CASUAL
  COMPETITIVE
  HARDCORE
}

enum CommType {
  VOICE
  TEXT
  PING_ONLY
}

// --------------------------------------
// 6. ADMIN AUDIT LOGS
// --------------------------------------

model AuditLog {
  id          String   @id @default(uuid())
  action      String   // e.g., "BAN_USER", "WARN_USER", "MANUAL_REP"
  details     String?  // e.g., "Reason: Toxic behavior in Lobby #123"
  
  adminId     String   // Who did the action?
  admin       User     @relation("AdminActions", fields: [adminId], references: [id])
  
  targetId    String?  // Who was it done to? (Stored as string so logs survive user deletion)
  createdAt   DateTime @default(now())
}

// --------------------------------------
// 7. TRUST GRAPH (EigenTrust System)
// ðŸ†• NEW MODEL
// --------------------------------------

model TrustEdge {
  id            String   @id @default(uuid())
  sourceUserId  String   // Who is giving trust
  targetUserId  String   // Who is receiving trust
  weight        Float    @default(0.8)  // Trust strength (0-1)
  source        String   @default("ENDORSEMENT") // ENDORSEMENT, SESSION_RATING, MANUAL
  createdAt     DateTime @default(now())
  
  // Relations
  sourceUser    User     @relation("GivenTrust", fields: [sourceUserId], references: [id], onDelete: Cascade)
  targetUser    User     @relation("ReceivedTrust", fields: [targetUserId], references: [id], onDelete: Cascade)
  
  // Constraints
  @@unique([sourceUserId, targetUserId])
  @@index([sourceUserId])
  @@index([targetUserId])
}
